{% extends "base.html" %}

{% block content %}
<h1>Import Contacts from CSV</h1>

<div class="mb-3">
    <a href="{% url 'contact_list' %}" class="btn btn-sm btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to list
    </a>
</div>

<form id="csvForm" enctype="multipart/form-data" class="mb-3 row g-2">
    {% csrf_token %}
    <div class="col-md-6 col-lg-4">
        <input type="file" name="csv_file" id="csvFile" class="form-control" accept=".csv">
    </div>
    <div class="col-auto">
        <button type="button" id="selectAllBtn" class="btn btn-secondary">Select All</button>
        <button type="button" id="importButton" class="btn btn-primary">Import Selected</button>
    </div>
</form>

<div class="table-responsive" id="previewContainer" style="display:none;">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Select</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>City</th>
                <th>Status</th>
                <th>Data errors</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
async function previewCSV(file) {
    const formData = new FormData();
    formData.append('csv_file', file);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

    const res = await fetch("{% url 'preview_csv' %}", {
        method: 'POST',
        body: formData
    });

    const data = await res.json();
    const previewContainer = document.getElementById('previewContainer');
    const tbody = previewContainer.querySelector('tbody');
    tbody.innerHTML = '';

    if (!data.rows || data.rows.length === 0) {
        if (data.empty_file) {
            previewContainer.style.display = 'none';
            notyf.error("The uploaded CSV file is empty")
        }
        return;
    }

    previewContainer.style.display = 'block';

    data.rows.forEach(item => {
        const row = document.createElement('tr');
        if (!item.is_valid) row.classList.add('table-danger');

        const errorsHtml = item.errors.length > 0 ? item.errors.join('<br>') : '';

        row.innerHTML = `
            <td class="text-center">
                <input type="checkbox" ${!item.is_valid ? 'disabled' : ''}>
            </td>
            <td>${item.row.first_name || ''}</td>
            <td>${item.row.last_name || ''}</td>
            <td>${item.row.email || ''}</td>
            <td>${item.row.phone_number || ''}</td>
            <td>${item.row.city || ''}</td>
            <td>${item.row.status || ''}</td>
            <td>${errorsHtml}</td>
        `;
        tbody.appendChild(row);
    });
}

// Import button clicked event
document.getElementById('importButton').addEventListener('click', async function() {
    const rows = document.querySelectorAll('#previewContainer tbody tr');
    const selected_rows = [];

    rows.forEach(row => {
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.checked) {
            const cells = row.querySelectorAll('td');
            selected_rows.push({
                row: {
                    first_name: cells[1].textContent,
                    last_name: cells[2].textContent,
                    email: cells[3].textContent,
                    phone_number: cells[4].textContent,
                    city: cells[5].textContent,
                    status: cells[6].textContent
                }
            });
        }
    });

    if (selected_rows.length === 0) return notyf.error("No contact was selected");

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const res = await fetch("{% url 'import_csv_json' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({selected_rows})
    });

    const data = await res.json();
    if (data.success) {
        sessionStorage.setItem('toast', JSON.stringify({
            message: `Imported ${data.created} records`,
            type: 'success'
        }));
        
        window.location.href = "{% url 'contact_list' %}";
    } else {
        notyf.error("Import error: " + (data.error || "Unknown error"));    }
});

// File change event
document.getElementById('csvFile').addEventListener('change', function() {
    const file = this.files[0];
    if (file) previewCSV(file);
});

// Select all clicked event
document.getElementById('selectAllBtn').addEventListener('click', function() {
    const checkboxes = document.querySelectorAll('#previewContainer tbody input[type="checkbox"]');
    checkboxes.forEach(cb => { if (!cb.disabled) cb.checked = true; });
});
</script>
{% endblock %}