{% extends "base.html" %}

{% block content %}
<h2>Import Contacts from CSV</h2>

<form id="csvForm" enctype="multipart/form-data">
    {% csrf_token %}
  <input type="file" name="csv_file" id="csvFile" accept=".csv">
</form>
<button id="selectAllBtn">Select All</button>

<table id="previewTable" border="1">
  <thead>
    <tr>
      <th>Select</th>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Email</th>
      <th>Phone</th>
      <th>City</th>
      <th>Status</th>
      <th>Data errors</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="importButton">Import Selected</button>

<script>
    async function previewCSV(file) {
      const formData = new FormData();
      formData.append('csv_file', file);
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
      const res = await fetch("{% url 'preview_csv' %}", {
        method: 'POST',
        body: formData
      });
    
      const data = await res.json();
      const tbody = document.querySelector('#previewTable tbody');
      tbody.innerHTML = '';
    
      data.rows.forEach((item) => {
        const row = document.createElement('tr');
        if (!item.is_valid) row.style.backgroundColor = '#f8d7da';
    
        const errorsHtml = item.errors.length > 0 ? item.errors.join('<br>') : '';
    
        row.innerHTML = `
          <td><input type="checkbox" ${!item.is_valid ? 'disabled' : ''}></td>
          <td>${item.row.first_name || ''}</td>
          <td>${item.row.last_name || ''}</td>
          <td>${item.row.email || ''}</td>
          <td>${item.row.phone_number || ''}</td>
          <td>${item.row.city || ''}</td>
          <td>${item.row.status || ''}</td>
          <td>${errorsHtml}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // Import button clicked event
    document.getElementById('importButton').addEventListener('click', async function() {
        const rows = document.querySelectorAll('#previewTable tbody tr');
        const selected_rows = [];
    
        rows.forEach(row => {
            const checkbox = row.querySelector('input[type="checkbox"]');
            if (checkbox && checkbox.checked) {
                const cells = row.querySelectorAll('td');
                selected_rows.push({
                    row: {
                        first_name: cells[1].textContent,
                        last_name: cells[2].textContent,
                        email: cells[3].textContent,
                        phone_number: cells[4].textContent,
                        city: cells[5].textContent,
                        status: cells[6].textContent
                    }
                });
            }
        });
    
        if (selected_rows.length === 0) return alert("Nie zaznaczono żadnych rekordów!");
    
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
        const res = await fetch("{% url 'import_csv_json' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({selected_rows})
        });
    
        const data = await res.json();
        if (data.success) {
            alert(`Zaimportowano ${data.created} rekordów`);
            location.reload();
        } else {
            alert("Błąd importu: " + (data.error || "Nieznany błąd"));
        }
    });
    
    // File change event
    document.getElementById('csvFile').addEventListener('change', function() {
      const file = this.files[0];
      if (file) {
        previewCSV(file);
      }
    });

    // Select all clicked event
    document.getElementById('selectAllBtn').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('#previewTable tbody input[type="checkbox"]');
        checkboxes.forEach(cb => { if (!cb.disabled) cb.checked = true; });
      })
    </script>
{% endblock %}