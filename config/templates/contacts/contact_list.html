{% extends "base.html" %}
{% load static %}

{% block content %}
<h1>Contact List</h1>

<form method="get" class="row g-2 mb-3">
    <div class="col-sm-8 col-md-6 col-lg-4">
        <input
            type="text"
            name="q"
            class="form-control"
            placeholder="Search by first or last name"
            value="{{ request.GET.q }}"
        >
    </div>
    <div class="col-auto">
        <button class="btn btn-primary">
            Search
        </button>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead>
            <tr>
                <th>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>First Name</span>
                        <span class="sort-buttons">
                            <a href="?sort=first_name&dir=asc{% if current_query %}&q={{ current_query }}{% endif %}"
                               class="sort-btn {% if current_sort == 'first_name' and current_dir == 'asc' %}active{% endif %}">↑</a>
                            <a href="?sort=first_name&dir=desc{% if current_query %}&q={{ current_query }}{% endif %}"
                               class="sort-btn {% if current_sort == 'first_name' and current_dir == 'desc' %}active{% endif %}">↓</a>
                        </span>
                    </div>
                </th>
        
                <th>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Last Name</span>
                        <span class="sort-buttons">
                            <a href="?sort=last_name&dir=asc{% if current_query %}&q={{ current_query }}{% endif %}"
                               class="sort-btn {% if current_sort == 'last_name' and current_dir == 'asc' %}active{% endif %}">↑</a>
                            <a href="?sort=last_name&dir=desc{% if current_query %}&q={{ current_query }}{% endif %}"
                               class="sort-btn {% if current_sort == 'last_name' and current_dir == 'desc' %}active{% endif %}">↓</a>
                        </span>
                    </div>
                </th>
        
                <th>Email</th>
                <th>Phone</th>
                <th>City</th>
                <th>Weather</th>
                <th>Status</th>
                <th>Actions</th>
        
                <th>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Contact Created</span>
                        <span class="sort-buttons">
                            <a href="?sort=created_at&dir=asc{% if current_query %}&q={{ current_query }}{% endif %}"
                               class="sort-btn {% if current_sort == 'created_at' and current_dir == 'asc' %}active{% endif %}">↑</a>
                            <a href="?sort=created_at&dir=desc{% if current_query %}&q={{ current_query }}{% endif %}"
                               class="sort-btn {% if current_sort == 'created_at' and current_dir == 'desc' %}active{% endif %}">↓</a>
                        </span>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody>
            {% for contact in contacts %}
            <tr>
                <td>{{ contact.first_name }}</td>
                <td>{{ contact.last_name }}</td>
                <td>{{ contact.email }}</td>
                <td>{{ contact.phone_number }}</td>
                <td>{{ contact.city }}</td>
                <td>
                    <div class="weather-info d-flex flex-column align-items-start" id="weather-{{ contact.id }}">
                        <span class="weather-loading text-muted">Loading...</span>
                    </div>
                </td>
                <td>{{ contact.status }}</td>
                <td class="text-nowrap">
                    <a href="{% url 'contact_detail' contact.pk %}" 
                       class="btn btn-sm btn-outline-primary" 
                       data-bs-toggle="tooltip" 
                       data-bs-placement="top" 
                       title="View">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="{% url 'contact_edit' contact.pk %}" 
                       class="btn btn-sm btn-outline-secondary" 
                       data-bs-toggle="tooltip" 
                       data-bs-placement="top" 
                       title="Edit">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a href="#"
                        class="btn btn-sm btn-outline-danger"
                        data-delete-url="{% url 'contact_delete' contact.pk %}"
                        data-delete-name="{{ object }}"
                        data-bs-toggle="tooltip" 
                        data-bs-placement="top" 
                        title="Delete">
                        
                        <i class="bi bi-trash"></i>
                    </a>
                </td>
                <td>{{ contact.created_at|date:"Y.m.d H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9">We haven't found any contacts here. Click 'Add Contact' button at the top of the page to add a new one.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% comment %} PAGINATION FOR CONTACT LIST {% endcomment %}
{% include 'contacts/pagination.html' %}

<script>
    document.addEventListener("DOMContentLoaded", () => {

        const toastJSON = sessionStorage.getItem('toast');
        if (toastJSON) {
            const toast = JSON.parse(toastJSON);
            switch (toast.type) {
                case 'success': notyf.success(toast.message); break;
                case 'error': notyf.error(toast.message); break;
            }
            sessionStorage.removeItem('toast');
        }
        document.querySelectorAll('.weather-info').forEach(async container => {
            const contactId = container.id.split('-')[1];
    
            try {
                const res = await fetch(`/contacts/${contactId}/weather/`);
                if (!res.ok) throw new Error("API error");
                const data = await res.json();
    
                container.innerHTML = ''; 
    
                if (!data.weather || Object.keys(data.weather).length === 0) {
                    container.textContent = "No data";
                } else {
                    const topRow = document.createElement('div');
                    topRow.className = 'd-flex align-items-center mb-1';
    
                    if (data.weather.icon) {
                        const img = document.createElement('img');
                        img.className = 'weather-icon me-2';
                        img.src = `{% static '' %}${data.weather.icon}`;
                        img.alt = 'icon';
                        topRow.appendChild(img);
                    }
    
                    const desc = document.createElement('span');
                    desc.className = 'weather-description text-truncate';
                    desc.textContent = data.weather.description || '';
                    topRow.appendChild(desc);
    
                    const bottomRow = document.createElement('div');
                    bottomRow.className = 'weather-stats small text-muted';
                    bottomRow.innerHTML = `
                        Temp: ${data.weather.current?.temperature || ''} ${data.weather.units?.temperature || ''}<br>
                        Wind: ${data.weather.current?.windspeed || ''} ${data.weather.units?.windspeed || ''}
                    `;
    
                    container.appendChild(topRow);
                    container.appendChild(bottomRow);
                }
    
            } catch (err) {
                container.textContent = "Failed to load weather";
            }
        });
    });
    </script>
{% endblock %}